{% extends "base.html" %}

{% block title %}PDF Chat - StudyHub{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="page-header mb-4">
            <h2><i class="fas fa-comments me-2 text-primary"></i>Chat with PDFs</h2>
            <p class="text-muted">Upload your PDF documents and have intelligent conversations about their content.</p>
        </div>
    </div>
</div>

<div class="row">
    <!-- Upload Section -->
    <div class="col-lg-4 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload Documents</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="pdfFiles" class="form-label">Select PDF Files</label>
                        <input type="file" class="form-control" id="pdfFiles" multiple accept=".pdf" required>
                        <div class="form-text">You can upload multiple PDF files at once.</div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary" id="uploadBtn">
                            <i class="fas fa-upload me-2"></i>Process PDFs
                        </button>
                    </div>
                </form>
                
                <div id="uploadStatus" class="mt-3"></div>
                
                <hr>
                
                <div class="upload-info">
                    <h6><i class="fas fa-info-circle me-2 text-info"></i>Upload Guidelines</h6>
                    <ul class="small text-muted">
                        <li>Supported format: PDF files only</li>
                        <li>Maximum file size: 50MB per file</li>
                        <li>Multiple files can be uploaded together</li>
                        <li>Text-based PDFs work best</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat Section -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Chat Interface</h5>
            </div>
            <div class="card-body d-flex flex-column" style="height: 600px;">
                <!-- Chat Messages -->
                <div id="chatMessages" class="flex-grow-1 overflow-auto mb-3 p-3 bg-light rounded" style="min-height: 400px;">
                    <div class="welcome-message text-center text-muted py-5">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <h5>Welcome to PDF Chat!</h5>
                        <p>Upload your PDF documents to start chatting about their content.</p>
                        <p class="small">Once processed, you can ask questions like:</p>
                        <div class="example-questions text-start mt-3">
                            <span class="badge bg-primary me-2 mb-2">"What is the main topic of this document?"</span>
                            <span class="badge bg-secondary me-2 mb-2">"Summarize the key points"</span>
                            <span class="badge bg-success me-2 mb-2">"Explain the methodology used"</span>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="chat-input">
                    <form id="chatForm">
                        <div class="input-group">
                            <input type="text" class="form-control" id="chatInput" placeholder="Ask a question about your documents..." disabled>
                            <button type="submit" class="btn btn-primary" id="sendBtn" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                    <div class="form-text mt-2">
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            Tip: Be specific with your questions for better results
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Row -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-magic me-2"></i>Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <button class="btn btn-outline-primary w-100 quick-question" data-question="What is the main topic of this document?">
                            <i class="fas fa-question me-2"></i>Main Topic
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100 quick-question" data-question="Can you provide a summary of the key points?">
                            <i class="fas fa-list me-2"></i>Key Points
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100 quick-question" data-question="What are the main conclusions?">
                            <i class="fas fa-check-circle me-2"></i>Conclusions
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-warning w-100 quick-question" data-question="Explain this in simple terms">
                            <i class="fas fa-lightbulb me-2"></i>Simplify
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let documentsProcessed = false;

document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('uploadForm');
    const chatForm = document.getElementById('chatForm');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadStatus = document.getElementById('uploadStatus');
    
    // Upload form handler
    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('pdfFiles');
        const files = fileInput.files;
        
        if (!files.length) {
            showAlert('Please select at least one PDF file.', 'warning');
            return;
        }
        
        const formData = new FormData();
        for (let file of files) {
            formData.append('files', file);
        }
        
        // Show loading state
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        uploadStatus.innerHTML = '<div class="alert alert-info mb-0"><i class="fas fa-clock me-2"></i>Processing your PDF files...</div>';
        
        try {
            const response = await fetch('/upload-pdfs', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                uploadStatus.innerHTML = '<div class="alert alert-success mb-0"><i class="fas fa-check me-2"></i>' + result.message + '</div>';
                documentsProcessed = true;
                
                // Enable chat
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.placeholder = "Ask a question about your documents...";
                
                // Clear welcome message and show ready message
                chatMessages.innerHTML = `
                    <div class="message bot-message">
                        <div class="message-content">
                            <i class="fas fa-robot me-2"></i>
                            <strong>Documents processed successfully!</strong><br>
                            You can now ask questions about your PDF content. What would you like to know?
                        </div>
                        <small class="text-muted">${new Date().toLocaleTimeString()}</small>
                    </div>
                `;
                
                // Enable quick questions
                document.querySelectorAll('.quick-question').forEach(btn => {
                    btn.disabled = false;
                });
                
            } else {
                uploadStatus.innerHTML = '<div class="alert alert-danger mb-0"><i class="fas fa-exclamation-circle me-2"></i>' + result.error + '</div>';
            }
        } catch (error) {
            uploadStatus.innerHTML = '<div class="alert alert-danger mb-0"><i class="fas fa-exclamation-circle me-2"></i>Error uploading files. Please try again.</div>';
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Process PDFs';
        }
    });
    
    // Chat form handler
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const question = chatInput.value.trim();
        if (!question) return;
        
        if (!documentsProcessed) {
            showAlert('Please upload and process PDF documents first.', 'warning');
            return;
        }
        
        // Add user message
        addMessage(question, 'user');
        chatInput.value = '';
        
        // Show typing indicator
        const typingId = addTypingIndicator();
        
        // Disable input
        chatInput.disabled = true;
        sendBtn.disabled = true;
        
        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ question: question })
            });
            
            const result = await response.json();
            
            // Remove typing indicator
            removeTypingIndicator(typingId);
            
            if (result.success) {
                addMessage(result.answer, 'bot');
            } else {
                addMessage('Sorry, I encountered an error: ' + result.error, 'bot', true);
            }
        } catch (error) {
            removeTypingIndicator(typingId);
            addMessage('Sorry, I encountered an error while processing your question.', 'bot', true);
        } finally {
            // Re-enable input
            chatInput.disabled = false;
            sendBtn.disabled = false;
            chatInput.focus();
        }
    });
    
    // Quick question handlers
    document.querySelectorAll('.quick-question').forEach(button => {
        button.addEventListener('click', function() {
            if (!documentsProcessed) {
                showAlert('Please upload and process PDF documents first.', 'warning');
                return;
            }
            
            const question = this.getAttribute('data-question');
            chatInput.value = question;
            chatForm.dispatchEvent(new Event('submit'));
        });
    });
});

function addMessage(content, sender, isError = false) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message${isError ? ' error-message' : ''}`;
    
    const time = new Date().toLocaleTimeString();
    const icon = sender === 'user' ? '<i class="fas fa-user me-2"></i>' : '<i class="fas fa-robot me-2"></i>';
    
    messageDiv.innerHTML = `
        <div class="message-content">
            ${icon}
            ${content.replace(/\n/g, '<br>')}
        </div>
        <small class="text-muted">${time}</small>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    const id = 'typing-' + Date.now();
    typingDiv.id = id;
    typingDiv.className = 'message bot-message typing-indicator';
    
    typingDiv.innerHTML = `
        <div class="message-content">
            <i class="fas fa-robot me-2"></i>
            <span class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </span>
            Thinking...
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    return id;
}

function removeTypingIndicator(id) {
    const element = document.getElementById(id);
    if (element) {
        element.remove();
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}